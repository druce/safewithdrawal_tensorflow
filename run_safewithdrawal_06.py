#!/home/ubuntu/anaconda2/bin/python

# MIT License

# Copyright (c) 2016 Druce Vertes drucev@gmail.com

# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

from __future__ import print_function

import argparse
import pickle
from time import strftime
import sys
import os

import numpy as np
import pandas as pd

gamma = 6.0
fileprefix = "best%02.0f" % gamma
bestfile = "%s.pickle" % (fileprefix)

max_unimproved_steps = 2000

# startval = 100
# years_retired = 30
# const_spend_pct = .02
# const_spend = startval * const_spend_pct

# var_spend_pcts = pd.Series(np.ones(years_retired) * 0.02)
# var_spend_pcts[-1]=1.0
# stock_allocations = pd.Series(np.ones(years_retired) * 0.65)

startval = 100
years_retired = 30

#Objective: 5.532400

const_spend = 0.056814212343
var_spend_pcts = pd.Series([0.0487484582839013, 0.052064278112707051, 0.054283440648036543, 0.055358685319862926, 0.056964481357028647, 0.059392065048593241, 0.060975168781251018, 0.062928703870758496, 0.066927275187711216, 0.070518139976767022, 0.074027103376216652, 0.078309946366581576, 0.083608202035011014, 0.087290103019714751, 0.090141160902192416, 0.094393100130908569, 0.09912036503003184, 0.10570948051164114, 0.11293608808945538, 0.12022883643614249, 0.12685041578279302, 0.13586572879900299, 0.14817244533359028, 0.16259081966824263, 0.18320380106112127, 0.21268517966685346, 0.2579506157260093, 0.33730892752801139, 0.50103229237991043, 1.0000000001165821])
stock_allocations = pd.Series([0.98996309608103883, 0.98362319235218676, 0.97797282796669438, 0.96917360199044766, 0.96838174555623213, 0.96192228254266399, 0.96016423934774175, 0.95723510477668083, 0.95547248473655633, 0.95491337861891157, 0.95476860362127203, 0.95125735389379107, 0.95025837341836628, 0.94728200788028205, 0.93806113457348517, 0.93569037075640704, 0.93051462697536158, 0.92675652746290738, 0.9172091612651897, 0.90934087049166057, 0.90856935843553799, 0.90744713046351688, 0.90443300539788873, 0.89449647074510052, 0.89285290778645277, 0.88488045391638293, 0.87771396029052773, 0.86873524238917899, 0.8632277469222267, 0.85565449640642255])

#Objective: 4.777180

const_spend = 0.062482504315
var_spend_pcts = pd.Series([0.046948059137788122, 0.052430141668950596, 0.055430610445051966, 0.05588947559043235, 0.057597711548853237, 0.061511835974758067, 0.062861313369496019, 0.063675350093496785, 0.069512692068985318, 0.073209755712985533, 0.076362407903941568, 0.080592286047816375, 0.087090394227863646, 0.090853105534043771, 0.093136639721977707, 0.098266921514186312, 0.10307186436544315, 0.10965490654349351, 0.11702999358472103, 0.12500616681434881, 0.1307654657317662, 0.13947948789191048, 0.15192018455956802, 0.16526999239478579, 0.18575692994459608, 0.21481445491229237, 0.25911607124869407, 0.33780707502949686, 0.50131190136433779, 1.0000000001165821])
stock_allocations = pd.Series([0.98565259501309066, 0.97914508493111596, 0.97561315828529349, 0.96913286401641552, 0.96774995169218525, 0.96192509303240181, 0.96026353361552597, 0.95777761170415299, 0.95479510999387496, 0.95419113206645656, 0.95310425723300973, 0.95113888859041806, 0.94979133217672362, 0.94805103607411734, 0.93897812886795706, 0.93645077173660551, 0.93122785218648851, 0.9265639756610291, 0.91754762722640648, 0.9099202734357581, 0.90907676277665372, 0.90783818391730053, 0.90462345720828097, 0.89489281390272313, 0.89303338573804303, 0.88489679614955619, 0.87774880094077379, 0.86877287918170354, 0.8632330121599604, 0.8556596243649095])

#Objective: 4.784354

const_spend = 0.065710308412
var_spend_pcts = pd.Series([0.046945001881520086, 0.05239224670275483, 0.055388225552163925, 0.055866021949616589, 0.057589246876832013, 0.06151311182706537, 0.062886333754482479, 0.063712890208379072, 0.069592493046403289, 0.073335662137692381, 0.076531541887295676, 0.080814313151345615, 0.08748444293342561, 0.091372751447718017, 0.093703801336349743, 0.099105995547102685, 0.10408010150424267, 0.11083440549025025, 0.11843890179429249, 0.12683118151011807, 0.132504836112708, 0.1412856236350126, 0.15397179623237287, 0.16691705168665322, 0.1874447195494216, 0.2163261713330043, 0.26000111507055368, 0.33819969509538667, 0.50153554705482106, 1.000000000])
stock_allocations = pd.Series([0.98291807047988933, 0.97633676032112038, 0.97416161773084309, 0.96912934168378517, 0.9673844862559251, 0.96133174762922569, 0.96097488366148642, 0.95814655392801873, 0.95351248396877997, 0.95332626795239361, 0.9533187528085354, 0.95106451336554021, 0.94948502474240126, 0.94853668812891212, 0.93954351042199091, 0.9369466061813212, 0.93171551749692949, 0.92641338063587864, 0.91776576454181213, 0.91033949491490196, 0.90944734479325928, 0.90812640286167401, 0.90476916284024189, 0.89520093511129117, 0.89317730018677377, 0.88491100265521927, 0.87777750990162684, 0.86880407829762762, 0.86323760124986471, 0.85566401201661857])

#Objective: 4.785632

const_spend = 0.066380048274
var_spend_pcts = pd.Series([0.046942489991125415, 0.052381867750906946, 0.055376304144526919, 0.055857984716955966, 0.057583771265202859, 0.06150651982169935, 0.062883848853336297, 0.06371453884366847, 0.069593106013293091, 0.073340523370016814, 0.076543277055569098, 0.080832500026518719, 0.087518278291160476, 0.091425365331841354, 0.093769994376575891, 0.099211209335377887, 0.10421549460702235, 0.11100390900033544, 0.11865455928527642, 0.12712502511942428, 0.13280328161552832, 0.14161239780070853, 0.15435903942239249, 0.1672445482599117, 0.18779214759395108, 0.21664861706166127, 0.2601965170565872, 0.33828814537170426, 0.50158637558403174, 1.0])
stock_allocations = pd.Series([0.9823368781066294, 0.97574163093473221, 0.97385639120022749, 0.96912930315347301, 0.96730711445602935, 0.96120678292173423, 0.96112518736605979, 0.95822593280757651, 0.95325751135175252, 0.9532575110571978, 0.9532344090976832, 0.95104972867096116, 0.9494207410006561, 0.94863917813797216, 0.93966140738841597, 0.93705157759905322, 0.93182034051946938, 0.92637966735950883, 0.91781119466330885, 0.91043108963693997, 0.90952857245067864, 0.90818966577947924, 0.904801572109318, 0.89527003579457665, 0.89320998933594076, 0.88491434302897254, 0.87778410584111077, 0.86881129473149388, 0.86323868426060357, 0.85566504051746828])

bond_allocations = 1 - stock_allocations

# save starting scenario
pickle_list = [const_spend, var_spend_pcts, stock_allocations, bond_allocations]
pickle.dump( pickle_list, open( bestfile, "wb" ) )

# start with a learning rate that learns quickly, gradually reduce it
# run once with 50 or 100 steps to see which learning rates are effective
# then plug in that solution and run each til no improvement for a large number of steps

for learning_rate in [
        #0.00001, # too coarse, may be NaN
        0.00003, # too coarse, may be NaN
        0.000001, # coarse
        0.000003, # coarse
        0.0000001, # workhorse
        0.00000003, 
        0.00000001, # diminishing returns
        0.000000003,
        #0.000000001, #superfine
        #0.0000000003, 
        #0.0000000001, 
        #0.00000000001, 
]:
    cmdstr = './safewithdrawal.py %.12f %d %f %s' % (learning_rate, max_unimproved_steps, gamma, fileprefix)
    print(cmdstr)
    os.system(cmdstr)

